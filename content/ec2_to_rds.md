Title: EC2からRDSへの接続と、RDSへのデータ投入&日本語文字化け対応の備忘録 
Date: 2019-04-29
Category: 備忘録
Tags: AWS
Slug: ec2_to_rds
Authors: Naoto Yamaguchi
Summary: RDS文字化け対応備忘録<br><img src="https://paper-attachments.dropbox.com/s_8FAC27AC251845FE76C63F0EAF156DF8B3F4D3C17D70B16D9D9AEE81A162B247_1559630545434_rds.png">

## 動機
あるプロジェクトで、EC2インスタンスからRDSに接続できるように設定する必要がありました。また、RDSへのデータの投入も初めてだったので、記録を残しておこうと思いました。


## EC2からRDSへの接続
EC2からRDSへ接続するには以下のことが必要です。
* EC2インスタンスに接続できる
* RDSインスタンスが管理下にある
* EC2インスタンスでmysqlコマンドを実行できる
* RDSインスタンスのマスターユーザー名とマスターパスワードを知っている。もしくは、AWSコンソールにログインできる
* RDSインスタンスのセキュリティグループで、MySQLポート(3306)を開放している（できる）

ここでは、目的のEC2インスタンスとRDSインスタンスが作成してあることは前提とします。作成については他の記事を参照してください。

EC2インスタンスからRDSインスタンスへは、
```
mysql -h [ENDPOINT] -P 3306 -u [Username] –p [Name]
```
というコマンドで接続することができるのですが、そのためには以下の準備が必要です。
* mysqlコマンドが実行できる
* 今回のようにmysqlがEC2インスタンスにインストールされていない場合は、以下のようにしてインストールしました
```
$ sudo yum install mysql
```
インストールできているかの確認は
```
$ yum list installed | grep mysql
```


* RDSインスタンスのエンドポイントがわかっている
* これはAWSコンソールから確認できます。
* [RDS]->[データベース]->インスタンスを選択->[接続とセキュリティ]で確認できます。
* RDSインスタンスのマスターユーザー名がわかっている
* マスターユーザー名はRDSインスタンス作成時に指定するものです。
* [RDS]->[データベース]->インスタンスを選択->[設定]で確認できます。
* RDSインスタンスのパスワードがわかっている
* パスワードはAWSコンソールから確認はできませんが、変更することはできます。
* [RDS]->[データベース]->インスタンスを選択->[変更]で、設定という項目で、「新しいマスターパスワード」という欄があるので、そこで変更することができます。

以上で、接続への必要な情報は揃うと思います。

最後に、EC2インスタンスから、接続の要求をした際に、それを受け入れるための準備をRDS側でしておかないといけません（デフォルトでは許可されていません）。
[RDS]->[データベース]->インスタンスを選択->[接続とセキュリティ]->[セキュリティグループのルール]で設定されている、セキュリティグループのinboundでMySQLポート(3306)を開放しましょう。
以下の記事を参考になると思います。
[RDSへEC2から接続する方法 -HACK NOTE](https://hacknote.jp/archives/39927/)
[AWS RDS ドキュメント](https://docs.aws.amazon.com/ja_jp/AmazonRDS/latest/UserGuide/CHAP_GettingStarted.CreatingConnecting.MySQL.html)

これで、上記のコマンドを実行することで無事接続できるはずです！


## RDSへのデータ投入
ECSインスタンス上にあるデータをRDSのDBに投入する方法です。
以下の記事を参考にしました。
RDSインスタンスにログインした状態で、データベースを指定し(use database_name)、
```
LOAD DATA LOCAL INFILE 'sample.csv'
REPLACE INTO TABLE database_name
CHARACTER SET utf8
FIELDS TERMINATED BY ','
OPTIONALLY ENCLOSED BY '"'
IGNORE 1 LINES;
```
でEC2上にあるCSVファイルをインポートできます。
ファイル名の指定は、RDSインスタンスにログインする際にいたディレクトリからのパスになりますので、注意してください。またファイル名に日本語や、\などの文字が入っている場合も、上手くインポートできないことがあるので注意してください。

さて、すでに作成していたテーブルに上記のコマンドでデータをインポートできたのですが、テーブルの中身を確認してみると、日本語が文字化けしてしまっていました。。。

## 日本語文字化けに対する対処
やるべきことは、
データベース、もしくはテーブルのキャラクターセットをutf8に変更することです。
[RDSで日本語が文字化けする問題](https://qiita.com/reoy/items/e355debf1e2b2abd703b)という記事を参考に、AWSコンソールから、RDSインスタンスのパラメータグループを設定しました。
これだけ(Step4まで)では、すでに作成されているDBに対してパラメターグループの設定を行っても"character_set_database"は、latin1 のまま変更されないので、
[RDS の mySQL で日本語が文字化けて困った時の対応方法](http://d.hatena.ne.jp/It_lives_vainly/touch/20160906/1473154857)を参考に、設定すると無事日本語文字化けが直りました。
```
$ ALTER DATABASE database_name default character set utf8
```
コマンドが重要です。

今後、RDSインスタンス新規作成の際に、パラメータグループをきちんと設定すると良さそうです。


どうでも良いですが、mysqlのテーブル名は最長で63文字らしいです。
